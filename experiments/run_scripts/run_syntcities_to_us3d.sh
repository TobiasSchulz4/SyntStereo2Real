#!/usr/bin/env bash
set -e

# Run full SyntCities -> US3D pipeline
# 1) Train translation model
# 2) Translate synthetic dataset
# 3) Train AANet on translated data
# 4) Evaluate AANet predictions (expects predictions already generated by AANet)

CONFIG_TRANSLATION="configs/config_translation_syntcities_us3d.yaml"
CONFIG_AANET="configs/config_aanet_training.yaml"
OUTPUT_ROOT="experiments"
CHECKPOINT_DIR="${OUTPUT_ROOT}/checkpoints/syntcities_to_us3d"
TRANSLATED_DIR="datasets/translated/syntcities_to_us3d"
EVAL_ROOT="datasets/aanet_eval/us3d"
DEVICE=${DEVICE:-cuda}

mkdir -p "${CHECKPOINT_DIR}" "${TRANSLATED_DIR}"

# Train translator
python -m src.trainers.train_translation \
  --config "${CONFIG_TRANSLATION}" \
  --output_root "${CHECKPOINT_DIR}" \
  --device "${DEVICE}"

# Translate synthetic dataset using latest checkpoint
# NOTE: update CHECKPOINT_PATH if needed
CHECKPOINT_PATH=$(ls -t "${CHECKPOINT_DIR}"/checkpoints/checkpoint_*.pt | head -n 1)
python -m src.trainers.translate_dataset \
  --config "${CONFIG_TRANSLATION}" \
  --checkpoint "${CHECKPOINT_PATH}" \
  --output_root "${TRANSLATED_DIR}" \
  --device "${DEVICE}" \
  --use_edge

# Train AANet on translated dataset
python -m src.trainers.train_aanet --config "${CONFIG_AANET}"

# Evaluate AANet predictions (expects pred/gt/mask prepared in ${EVAL_ROOT})
python -m src.trainers.eval_aanet --root "${EVAL_ROOT}"
